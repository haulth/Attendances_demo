{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}
  {{ page_title }}
{% endblock %}
{% block content %}
  <section class="content">
    <div class="container-fluid">
      <!-- Small boxes (Stat box) -->
      <div class="row">
        <div class="col-lg-3 col-6">
          <!-- small box -->
          <div class="small-box bg-info">
            <div class="inner">
              <h3>{{ total_students }}</h3>
              <p>Tổng số học sinh</p>
            </div>
            <div class="icon">
              <i class="nav-icon fas fa-user-graduate"></i>
            </div>
            <a href="{% url 'manage_student' %}" class="small-box-footer">Thông tin <i class="fas fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
          <div class="small-box bg-success">
            <div class="inner">
              <h3>{{ total_staff }}</h3>
              <p>Tổng số giáo viên</p>
            </div>
            <div class="icon">
              <i class="nav-icon fas fa-users"></i>
            </div>
            <a href="{% url 'manage_staff' %}" class="small-box-footer">Thông tin <i class="fas fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
          <div class="small-box bg-purple">
            <div class="inner">
              <h3>{{ total_course }}</h3>
              <p>Địa điểm dạy</p>
            </div>
            <div class="icon">
              <i class="nav-icon fas fa-th-list"></i>
            </div>
            <a href="{% url 'manage_course' %}" class="small-box-footer">Thông tin <i class="fas fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
        <div class="col-lg-3 col-6">
          <div class="small-box bg-light"> 
            <div class="inner">
              <h3>{{ total_subject }}</h3> 
              <p>Tổng số lớp học</p>
            </div>
            <div class="icon">
              <i class="nav-icon fas fa-door-open"></i>

            </div>
            <a href="{% url 'manage_subject' %}" class="small-box-footer">Thông tin <i class="fas fa-arrow-circle-right"></i></a>
          </div>
        </div>

        <div class="col-lg-3 col-6">
          <div class="small-box bg-yellow">
            <div class="inner">
              <h3>{{ total_teaching }}</h3>
              <p>Tổng số lịch dạy</p>
            </div>
            <div class="icon">
              <i class="nav-icon fas fa-book"></i>
            </div>
            <a href="{% url 'manage_session' %}" class="small-box-footer">Thông tin <i class="fas fa-arrow-circle-right"></i></a>
          </div>
        </div>
        <!-- ./col -->
      </div>
      <!-- /.row -->

      <!-- Main row -->
      <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="datePicker">Chọn ngày:</label>
                <input type="date" id="datePicker" class="form-control" value="{{ current_date|date:'Y-m-d' }}">
            </div>
        </div>
      </div>

     <div class="row">
        <div class="col-md-6">
            <!-- BAR CHART for Students Present Today by Class -->
            <div class="card card-dark">
                <div class="card-header">
                    <h3 class="card-title" id="current-date">Học sinh có và vắng mặt ngày: </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <canvas id="studentsPresentChart" style="width: 100%; height: 400;"></canvas>
                    </div>
                </div>
            </div>
        </div> 
    
        <div class="col-md-6">
            <!-- Pie Chart for Classes with Schedule Today -->
            <div class="card card-dark">
                <div class="card-header">
                    <h3 class="card-title" id="current-date1">Lịch học ngày: </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <canvas id="classScheduleChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-12">
            <!-- BAR CHART for Student Overview by School -->
            <div class="card card-dark">
                <div class="card-header">
                    <h3 class="card-title">Tổng quan học sinh theo trường</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <canvas id="schoolOverviewChart" width="800" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /.container-fluid -->
</section>

{% endblock %}
{% block custom_js %}


<script>
  var studentsPresentChart;
  var classScheduleChart;

  $(document).ready(function() {
    // Biểu đồ số học sinh điểm danh hôm nay
    var studentsPresentChartCanvas = $('#studentsPresentChart').get(0).getContext('2d');

    // Chuyển đổi subject_list từ chuỗi JSON thành mảng
    var subjectList = JSON.parse('{{ subject_list|safe }}');

    // Tạo biểu đồ
    studentsPresentChart = new Chart(studentsPresentChartCanvas, {  // Không khai báo lại
        type: 'bar',
        data: {
            labels: subjectList,
            datasets: [
                {
                    label: 'Học sinh có mặt',
                    backgroundColor: '#00a65a',
                    data: {{ student_present_today_list|safe|escapejs }} // Số lượng học sinh có mặt
                },
                {
                    label: 'Học sinh vắng mặt',
                    backgroundColor: '#f39c12',
                    data: {{ student_absent_today_list }} // Số lượng học sinh vắng mặt
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        stepSize: 1,
                        fontColor: 'black' // Màu chữ trên trục y
                    },
                    gridLines: {
                        color: 'green' // Màu lưới
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontColor: 'blue' // Màu chữ trên trục x
                    },
                    gridLines: {
                        color: 'green' // Màu lưới
                    }
                }]
            },
            legend: {
                labels: {
                    fontColor: 'blue' // Màu chữ của legend
                }
            },
            title: {
                display: true,
                text: 'Học sinh có và vắng mặt theo lớp',
                fontColor: 'black', // Màu chữ của tiêu đề
                fontSize: 16
            },
            animation: {
                duration: 2000,
                easing: 'easeOutBounce',
                animateScale: true,
                animateRotate: true
            },
            hover: {
                animationDuration: 1000,  // Hiệu ứng khi hover (1 giây)
            }
        }
    });

  
    // Biểu đồ lịch học hôm nay
    var classScheduleChartCanvas = $('#classScheduleChart').get(0).getContext('2d');
    classScheduleChart = new Chart(classScheduleChartCanvas, {
      type: 'pie',
      data: {
        labels: ['Lớp có lịch học hôm nay', 'Lớp không có lịch học'],
        datasets: [{
          data: [{{ classes_with_schedule_today }}, {{ total_classes }} - {{ classes_with_schedule_today }}],
          backgroundColor: ['green', 'red'],  // Màu nổi bật và có độ tương phản cao
          borderColor: '#fff',  // Đường viền trắng giúp làm nổi bật từng phần
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Biểu đồ lịch học hôm nay',
            font: {
              size: 22,
              weight: 'bold',  // Làm cho tiêu đề nổi bật hơn
              family: 'Arial'
            },
            color: '#333'  // Màu đậm cho tiêu đề
          },
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(tooltipItem) {
                var label = tooltipItem.label || '';
                var value = tooltipItem.raw;
                return label + ': ' + value + ' lớp';
              }
            },
            backgroundColor: '#444',  // Màu nền tối cho tooltip
            titleColor: '#fff',
            bodyColor: '#fff'
          },
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 16
              },
              color: '#000'  // Màu đen cho chú thích
            }
          }
        },
        hover: {
          mode: 'nearest',
          intersect: true,
          animationDuration: 400  // Thêm hiệu ứng hover mượt mà
        },
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 1500  // Tăng thời gian hiển thị biểu đồ để tạo hiệu ứng mượt
        }
      }
    });

    // cập nhạt ngày cho biểu đồ
    $('#datePicker').on('change', function() {
      var selectedDate = $(this).val();

      $.ajax({
        url: '{% url "filter_data_by_date" %}',
        method: 'GET',
        data: { date: selectedDate },
        success: function(response) {
          console.log(response);  
        
          updateCharts(response.student_present_today_list,response.student_absent_today_list, response.classes_with_schedule_today, response.total_classes);
          
        },
        error: function(xhr, status, error) {
          console.error("Lỗi khi gửi yêu cầu AJAX:", status, error);
        }
      });
    });
    
    var course_name_list = {{ course_name_list|safe }};
    var student_count_list_by_school = {{ student_count_list_by_school|safe|escapejs }};

    if (Array.isArray(course_name_list) && Array.isArray(student_count_list_by_school)) {
        var schoolOverviewChartCanvas = $('#schoolOverviewChart').get(0).getContext('2d');
        
        // Dữ liệu biểu đồ
        var schoolOverviewChartData = {
            labels: course_name_list,
            datasets: [{
                label: 'Số học sinh',
                backgroundColor: ['#36a2eb'], 
                borderColor: '#fff',
                borderWidth: 2,
                hoverBackgroundColor: ['#36a2eb'],   // Màu nổi bật khi hover
                hoverBorderColor: '#000',  // Đường viền đen khi hover
                data: student_count_list_by_school
            }]
        };
        
        // Tùy chọn hiển thị
        var schoolOverviewChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        stepSize: 10,  // Điều chỉnh bước nhảy phù hợp với dữ liệu lớn hơn
                        fontColor: '#333',  // Màu chữ trục Y
                        callback: function(value) { return value + " học sinh"; }  // Thêm đơn vị vào trục Y
                    },
                    gridLines: {
                        color: '#e9ecef'  // Màu lưới nhẹ
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontColor: '#333',  // Màu chữ trục X
                        fontSize: 12
                    },
                    gridLines: {
                        color: '#e9ecef'  // Màu lưới nhẹ
                    }
                }]
            },
            legend: {
                display: true,
                labels: {
                    fontColor: '#000',  // Màu chữ cho legend
                    fontSize: 14
                }
            },
            title: {
                display: true,
                text: 'Biểu đồ tổng quan học sinh mỗi trường',
                fontColor: '#333',  // Màu tiêu đề
                fontSize: 18,
                fontFamily: 'Arial'
            },
            // Thêm hiệu ứng animation
            animation: {
                duration: 1500,  // Thời gian animation (1.5 giây)
                easing: 'easeOutBounce',  // Hiệu ứng bật khi hiển thị
                animateScale: true,
                animateRotate: true
            },
            hover: {
                animationDuration: 1000,  // Hiệu ứng khi hover
            },
            tooltips: {
                enabled: true,
                backgroundColor: '#000',  // Màu nền tooltip
                titleFontColor: '#fff',  // Màu chữ tiêu đề tooltip
                bodyFontColor: '#fff',  // Màu chữ nội dung tooltip
                callbacks: {
                    label: function(tooltipItem, data) {
                        var label = data.datasets[0].label || '';
                        var value = tooltipItem.yLabel;
                        return label + ': ' + value + ' học sinh';
                    }
                }
            }
        };

        // Tạo biểu đồ
        var schoolOverviewChart = new Chart(schoolOverviewChartCanvas, {
            type: 'bar',
            data: schoolOverviewChartData,
            options: schoolOverviewChartOptions
        });
    }


    // Hiển thị ngày hiện tại
    var today = new Date();
    var date = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
    document.getElementById('current-date').innerHTML += date;
    document.getElementById('current-date1').innerHTML += date;

  });

    // Xử lý hiển thị ngày cho ngày đã chọn
    $('#datePicker').on('change', function() {
      var selectedDate = $(this).val();

      if (selectedDate) {
        var dateParts = selectedDate.split('-');
        var formattedDate = dateParts[2] + '/' + dateParts[1] + '/' + dateParts[0];

        document.getElementById('current-date').innerHTML = "Số học sinh điểm danh trong ngày: " + formattedDate;
        document.getElementById('current-date1').innerHTML = "Lịch học hôm nay: " + formattedDate;
      } else {
        document.getElementById('current-date').innerHTML = "Số học sinh điểm danh trong ngày: " + date;
        document.getElementById('current-date1').innerHTML = "Lịch học hôm nay: " + date;
      }
    });


  // Chức năng cập nhật biểu đồ khi nhận dữ liệu mới
  function updateCharts(studentData, absentData, classesWithSchedule, totalClasses) {
    // Nếu dữ liệu rỗng, gán giá trị mặc định là 0
    studentData = studentData.length > 0 ? studentData : [0];
    absentData = absentData.length > 0 ? absentData : [0];
  
    // Cập nhật biểu đồ với học sinh có mặt
    studentsPresentChart.data.datasets[0].data = studentData;
    studentsPresentChart.data.datasets[1].data = absentData;
    studentsPresentChart.update();
  
    // Cập nhật biểu đồ với số lớp có lịch học hôm nay
    classScheduleChart.data.datasets[0].data = [classesWithSchedule, totalClasses - classesWithSchedule];
    classScheduleChart.update();
  }
  


</script>

{% endblock  %}
